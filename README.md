# modern-skeleton プログラム説明

* modern-skeleton は、flaskアプリをコンテナ化、AppRunnerによるSaaS化、までをご覧いただくためのサンプリコードです。

## 動作確認環境

1. Mac BigSur 11.6.2
2. Python version3.8.8 (Anacondaパッケージをインストール）
3. 各種pythonライブラリー(pip v3で導入）
  - 基本的にAnacondaでなくてもpython3と関連ライブラリー、日本語フォントがあれば稼働するはず。
4. docker
  - docker desktop: 4.5.0
  - Engine: 20.10.12

## 利用方法
利用方法には３つの方法があります。以下、それぞれの方法についてこの後説明しています。
1. ソースコードをもとに起動（手元のPCなどで）
2. Dockerイメージから起動（Docker環境で）
3. SaaS形式で利用（ブラウザからサイトへアクセスして）

### ソースをもとに実行する

#### ソースを取得する

`$ git clone (リポジトリURL)` にてクローンするか、または、GitHubの [Code]-[Download ZIP] から取得して、
`$ unzip apa-gui.zip` 等で展開してください。

#### 実行環境構築

1. pythonバージョン3 の確認  
  個別にPython v3を導入、またはAnacondaのようなAll-Inパッケージを導入してPython v3が利用できるようにしておきます。
2. 日本語フォントの事前導入  
  matplotlibで日本語表示をさせるために日本語フォントを導入設定しておく必要があります。apa-guiでは、フォント「IPAexGothic」を使用しているため、予めこれを導入しておきます。Macの場合はフォントをダウンロードし、アプリであるFont Book を使ってフォントファイルを読込んで利用可能にしてください。
  フォントを変更したい場合、apa-config.py のパラメータ JP_FONT でフォント名を指定します。
  フォントのダウンロード元は、以下のサイトです。この中にMac向けのインストール手順も記載されています。
  https://moji.or.jp/ipafont/ipafontdownload/
3. pythonライブラリーのインストール  
  requirements.txt では、導入するライブラリーをリストしています。
```sh
$ pip install --upgrade pip
$ pip install -r requirements.txt
```

#### 起動

以下のコマンドを実行し、表示されるURLにアクセスしてください。

```sh
$ python3 app.py
```

### Dockerイメージから起動する

Dockerを実行可能な環境にて、以下のコマンドを実行してください。

```sh
$ cd ./apa-gui
$ docker build . -t apa-gui
$ docker run -it --rm -p 5000:5000 apa-gui
```

### AWS App Runner で起動する

付属の `apprunner.yaml` を利用し、GitHubソースからデプロイできます。


## 仕様等

### 入力ファイルに関する仕様

1. ディレクトリ sample-data 下にあるサンプル棚卸し入力シートに合わせたデータを準備してください。
2. 入力ファイルはエクセル形式です。APA棚卸しシートはME用を含めて複数タブがありますが、使うのはそのうち２つです。
3. 必ず使うのは「システム一覧」タブです。
4. サーバーについては、「サーバー一覧（ME利用時用）」、「サーバー一覧（手入力用）」のどちらか一方のみを使用します。使用しない方のタブを必ず削除しておいてください。
5. タブ名称は上記であること。他のタブがあっても参照しません。
6. 各タブの先頭行は各項目名称が記載され、それらは予め apa-config.py ファイルで定義された用語であること。項目名称には改行文字や空白があると正しく動作しません。
7. 項目名称には改行文字や空白があると正しく動作しません。
8. 棚卸しシートの項目名称が変更された場合、apa-config.py の用語も変更する必要があります。
9. 必須項目が記載されていないと処理ができずエラーとなります。その場合、サーバー側エラーとブラウザで表示されます。大半のサーバー側エラーは、エクセルの入力項目の不整合、未記載などです。
10. 入力されたデータファイル及び、出力ファイルは、サーバー側では処理された後、自動的に削除され残りません。

### サンプルデータについて

1. sample-data ディレクトリは、棚卸シートのバージョンに合わせた手入力用、Migration Evaluator生成のエクセル用と2種類あります。
2. 棚卸しシートバージョンは適切なものを利用してください。

### デフォルト設定値：apa-config.py

1. 設定パラメータの大半は、このファイルに入っています。
2. 4象限を作成するロジックはなくなりました。エクセルシートのマクロで自動生成するようになったためです。

### 開発過程メモ(古いので参考程度に）

- CLIから開始し、Webアプリ、AppRunnerアプリへと改定していった。

- 第1ステップ（CLIからWebアプリへ）での追加・変更点
    - 入出力をコマンド引数でファイル名であったものからブラウザでファイルを選択入力などへ
    - ブラウザ入出力画面まわりを新規追加（app.pyファイルなど）
    - 処理時間がかかるグラフ作成についての同期から非同期への変更を将来検討

- 第2ステップ（WebアプリからAppRunnerアプリへ）
    - 環境変数の扱い（AppRunnerへは環境変数で渡す）
    - flaskでのIPアドレスとポート番号の扱い
    - 環境構築でflask導入などの事前準備
    - flaskアプリはAppRunnerでは稼働しない。最初の画面が表示されるが、次の画面に遷移しない。
    - ログインセッションの問題かと思い、機能を外しても初期画面表示はOKだが、次の画面に遷移しない。
    - 中断：一旦AppRunnerへの移行は断念
    
- 第3ステップ（WebアプリからLightsailアプリへ）
    - Amazon Linux2 OSのみ環境に導入
    - pythonはデフォルトv2なのにpipはv3でミスマッチ
    - 固定IPアドレスを設定し外部からpingなどは可能だが、外部パブIPと内部IP間で通信できず。iptablesを試すもカーネルが未対応とのエラー。
    - Firewall設定で全てのプロトコル、ポートをopenにしたが、ポート80ではルート権限がなくてエラー
    - プログラム自体は正常稼働しているが、外部からのアクセス方法がわからず一旦中断

### 今後の予定

1. プログラムエラーになるような必須項目（システム名称がgroupbyで使われているケースなど）は事前に弾くコードを作成する。（SERV_SYSTEM、ME_SYSTEMなど） 


